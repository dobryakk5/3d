# Unified Pipeline для обработки архитектурных планов

Этот pipeline автоматически выполняет полную обработку архитектурных планов в четыре этапа:
1. Обнаружение штриховки (Hatching detection)
2. Экспорт объектов в JSON (Export objects to JSON)
3. Выравнивание проемов (Align openings)
4. Визуализация полигонов с анализом junctions (Visualize polygons with junction analysis)

## Файлы pipeline

- `run_pipeline.py` - Основной Python скрипт pipeline
- `run_pipeline.sh` - Shell скрипт для удобного запуска
- `PIPELINE_README.md` - Эта инструкция

## Требования

### Необходимые файлы
- `plan_floor1.jpg` - Входное изображение плана
- `hatching_mask.py` - Скрипт обнаружения штриховки
- `export_objects.py` - Скрипт экспорта объектов
- `visualize_polygons_align.py` - Скрипт выравнивания проемов
- `visualize_polygons_w.py` - Скрипт визуализации с анализом junctions
- `cubicasa_vectorize.py` - Модуль векторизации
- `improved_junction_type_analyzer.py` - Модуль анализа junctions
- `model_best_val_loss_var.pkl` - Модель нейронной сети (для экспорта объектов)
- `floortrans/` - Директория с модулем FloorTrans

### Зависимости Python
Установите зависимости из файла `requirements.txt`:
```bash
pip install -r requirements.txt
```

Основные зависимости:
- numpy
- opencv-python
- PIL (Pillow)
- torch
- scipy
- svgwrite

## Использование

### Способ 1: Через shell скрипт (рекомендуется)
```bash
./run_pipeline.sh
```

### Способ 2: Через Python напрямую
```bash
python3 run_pipeline.py
```

### Способ 3: Из другой директории
```bash
cd /path/to/floor/directory
./run_pipeline.sh
```

## Процесс выполнения

Pipeline выполняет следующие шаги:

### Этап 1: Проверка файлов
- Проверяет наличие всех необходимых файлов
- Предупреждает об отсутствующих файлах модели

### Этап 2: Обнаружение штриховки
- Запускает `hatching_mask.py`
- Создает `enhanced_hatching_strict_mask.png`
- Обнаруживает стены на основе штриховки

### Этап 3: Экспорт объектов
- Запускает `export_objects.py`
- Создает `plan_floor1_objects.json`
- Экспортирует стены, окна, двери, колонны и junctions

### Этап 4: Выравнивание проемов
- Запускает `visualize_polygons_align.py`
- Нормализует толщину всех проемов
- Выравнивает проемы на одной стене к единому уровню
- Обновляет `plan_floor1_objects.json` с выровненными проемами

### Этап 5: Визуализация
- Запускает `visualize_polygons_w.py`
- Создает `wall_coordinates.json` и `wall_polygons.svg`
- Визуализирует результаты с анализом типов junctions

## Выходные файлы

После успешного выполнения pipeline создаются следующие файлы:

1. `enhanced_hatching_strict_mask.png` - Маска обнаруженных стен
2. `plan_floor1_objects.json` - Объекты плана (стены, окна, двери, колонны) с выровненными проемами
3. `wall_coordinates.json` - Координаты стен с анализом junctions
4. `wall_polygons.svg` - Визуализация плана с цветовой кодировкой

## Дополнительные скрипты

### visualize_polygons_align.py
Скрипт для выравнивания стен по проемам, решающий проблему J18-J25:

- Нормализует толщину всех проемов к минимальной толщине двери
- Группирует проемы по стенам (горизонтальные/вертикальные)
- Выравнивает проемы на одной стене к единому уровню
- Сохраняет исходные координаты для отладки

**Запуск скрипта выравнивания:**
```bash
python3 visualize_polygons_align.py
```

**Функции скрипта:**
- `normalize_opening_thickness()` - Приведение толщины проемов к единой
- `apply_alignment()` - Применение выравнивания к проемам
- `group_openings_by_wall()` - Группировка проемов по стенам
- `align_wall_group()` - Выравнивание группы проемов

## Обработка ошибок

Pipeline включает обработку ошибок на каждом этапе:
- Проверка наличия входных файлов
- Таймаут выполнения (5 минут на каждый скрипт)
- Детальное логирование ошибок
- Прекращение выполнения при критических ошибках

## Отладка

Если возникли проблемы:

1. Проверьте наличие всех необходимых файлов
2. Убедитесь, что установлены все зависимости
3. Проверьте права доступа к файлам
4. Запустите каждый скрипт отдельно для детальной диагностики

### Запуск отдельных скриптов
```bash
# Только обнаружение штриховки
python3 hatching_mask.py

# Только экспорт объектов
python3 export_objects.py

# Только выравнивание стен
python3 visualize_polygons_align.py

# Только визуализация
python3 visualize_polygons_w.py
```

## Производительность

- Примерное время выполнения: 3-7 минут
- Зависит от размера изображения и мощности компьютера
- Требуется минимум 4GB RAM для обработки больших изображений

## Примечания

- Pipeline работает с изображениями в формате JPG
- Для оптимальных результатов используйте изображения высокого качества
- Модель нейронной сети требуется только для этапа экспорта объектов
- При отсутствии модели этап экспорта будет пропущен с предупреждением
- Этап выравнивания проемов является важным для корректной визуализации
- Выровненные проемы сохраняются в `plan_floor1_objects.json` перед визуализацией

## Поддержка

При возникновении проблем:
1. Проверьте лог выполнения в терминале
2. Убедитесь, что все файлы на месте
3. Проверьте версию Python (требуется 3.7+)
4. Проверьте установленные зависимости

## Изменение параметров

Для изменения параметров обработки отредактируйте соответствующие файлы:
- `hatching_mask.py` - параметры обнаружения штриховки
- `export_objects.py` - параметры экспорта объектов
- `visualize_polygons_align.py` - параметры выравнивания стен
- `visualize_polygons_w.py` - параметры визуализации