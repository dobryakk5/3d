# Руководство по использованию добавления линий к маске штриховки

## Обзор

Новая функциональность позволяет автоматически добавлять горизонтальные и вертикальные линии к маске штриховки, если эти линии пересекаются с областями обнаруженной штриховки. Это особенно полезно для полных планов помещений, где стены могут быть представлены как штриховкой, так и сплошными линиями.

## Как это работает

1. **Обнаружение штриховки**: Сначала выполняется стандартное обнаружение штриховки с заданными параметрами
2. **Обнаружение линий**: Отдельно обнаруживаются горизонтальные и вертикальные линии с использованием морфологических операций
3. **Проверка пересечений**: Для каждой обнаруженной линии проверяется, пересекается ли она с областями штриховки
4. **Добавление линий**: Линии, которые пересекаются со штриховкой, добавляются к финальной маске

## Новые параметры

### ADD_LINES
- **Тип**: Boolean (True/False)
- **По умолчанию**: False
- **Описание**: Включить или выключить добавление линий
- **Рекомендуемые значения**: True для полных планов, False для планов только со штриховкой

### MIN_LINE_LENGTH
- **Тип**: Integer
- **По умолчанию**: 50
- **Описание**: Минимальная длина линии для добавления в пикселях
- **Рекомендуемые значения**: 
  - 20-30 для планов с короткими сегментами стен
  - 50-100 для стандартных планов
  - 100+ для планов с длинными стенами

### MIN_LINE_OVERLAP_RATIO
- **Тип**: Float (0.0-1.0)
- **По умолчанию**: 0.3
- **Описание**: Минимальное отношение пересечения линии с областью штриховки
- **Рекомендуемые значения**:
  - 0.2-0.3 для более чувствительного обнаружения
  - 0.4-0.5 для более строгого фильтра

## Использование в коде

### Способ 1: Изменение глобальных переменных

```python
# В файле enhanced_hatching_fixed.py измените параметры:
ADD_LINES = True  # Включить добавление линий
MIN_LINE_LENGTH = 50  # Минимальная длина линии
MIN_LINE_OVERLAP_RATIO = 0.3  # Порог пересечения

# Запустите основной тест
python enhanced_hatching_fixed.py
```

### Способ 2: Передача параметров в функцию

```python
from enhanced_hatching_fixed import detect_hatching_enhanced_fixed

# Загрузка изображения
image = Image.open('plan_floor1.jpg').convert('RGB')
img_np = np.array(image)

# Использование с добавлением линий
wall_mask = detect_hatching_enhanced_fixed(
    img_np,
    add_lines=True,
    min_line_length=50,
    min_line_overlap_ratio=0.3,
    min_area=2
)
```

### Способ 3: Использование тестового скрипта

```bash
# Запуск теста с разными параметрами
python test_line_enhancement.py
```

## Результаты тестирования

На тестовом изображении plan_floor1.jpg получены следующие результаты:

| Параметры | Пиксели | Горизонтальные линии | Вертикальные линии | Добавлено пикселей |
|-----------|---------|---------------------|-------------------|-------------------|
| Только штриховка | 609860 | 0 | 0 | 0 |
| + линии (стандарт) | 629205 | 26 | 32 | 19345 |
| + линии (строгие) | 628245 | 22 | 26 | 18385 |

### Зависимость от длины линии

| Длина линии | Горизонтальные | Вертикальные | Всего пикселей |
|-------------|----------------|--------------|----------------|
| 20 | 33 | 37 | 629119 |
| 30 | 26 | 30 | 628812 |
| 50 | 23 | 26 | 628492 |
| 80 | 11 | 17 | 627736 |

## Советы по настройке

1. **Для планов с хорошим качеством**: Используйте `MIN_LINE_LENGTH = 50` и `MIN_LINE_OVERLAP_RATIO = 0.3`
2. **Для планов с шумом**: Увеличьте `MIN_LINE_LENGTH` до 80-100 и `MIN_LINE_OVERLAP_RATIO` до 0.4-0.5
3. **Для планов с тонкими линиями**: Уменьшите `MIN_LINE_LENGTH` до 20-30
4. **Для максимального покрытия**: Используйте `MIN_LINE_OVERLAP_RATIO = 0.2`

## Визуализация результатов

Тестовый скрипт создает следующие файлы:
- `test_1_no_lines.png` - только штриховка
- `test_2_with_lines.png` - штриховка + линии
- `test_3_strict_lines.png` - строгие параметры
- `test_diff_basic.png` - разница (добавленные линии)
- `test_line_length_*.png` - результаты с разными длинами линий

## Технические детали

### Обнаружение линий
Используются морфологические операции с прямоугольными ядрами:
- Горизонтальные линии: ядро (kernel_length × 1)
- Вертикальные линии: ядро (1 × kernel_length)

### Проверка пересечений
Линия добавляется к маске, если:
`intersection_area / line_area >= MIN_LINE_OVERLAP_RATIO`

### Интеграция с фильтрацией
Добавление линий происходит после основной фильтрации по MIN_AREA, но до финальной морфологической обработки.