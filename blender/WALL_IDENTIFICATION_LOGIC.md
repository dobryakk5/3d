# Логика определения и нумерации стен по анализу меша

## Дата создания: 2025-10-27
Этот документ описывает логику идентификации физических стен здания на основе анализа граней меша после Voxel Remesh.

---

## 1. Координатная система Blender

В этом проекте используется следующая система координат:

```
     X (горизонталь: лево/право)
     ↑
     |
     |
     +------→ Z (горизонталь: вперед/назад, глубина)
    /
   /
  ↓
 Y (вертикаль: вверх/вниз, ИНВЕРТИРОВАНА - рост Y идет вниз)
```

### Важно:
- **X** - горизонтальная ось (лево/право)
- **Y** - вертикальная ось (вверх/вниз), **ИНВЕРТИРОВАНА** (рост Y = движение вниз)
- **Z** - горизонтальная ось (вперед/назад, глубина)

**При анализе нормалей стен компонента Z ИГНОРИРУЕТСЯ!**
**Работаем только с (normal.x, normal.y)!**

---

## 2. Определение стен

### 2.1. Критерии одной физической стены

Грани принадлежат одной физической стене, если выполняются ОБА условия:

#### Условие 1: Одинаковая доминантная нормаль
Нормаль грани `(nx, ny, nz)` имеет доминантную компоненту, если:
- `|nx| > 0.7` ИЛИ `|ny| > 0.7`

Компонента `nz` **ИГНОРИРУЕТСЯ** при определении направления стены.

#### Условие 2: Грани лежат на одной линии

**Для стен с нормалью по оси X** (`|nx| > 0.7`):
- Доминантная ось: **X**
- Грани группируются по **близкому значению Y**
- Вдоль стены **X меняется**
- Критерий: `|face.center.y - wall_y| < tolerance`

**Для стен с нормалью по оси Y** (`|ny| > 0.7`):
- Доминантная ось: **Y**
- Грани группируются по **близкому значению X**
- Вдоль стены **Y меняется**
- Критерий: `|face.center.x - wall_x| < tolerance`

### 2.2. Параметры алгоритма

- **Порог нормали**: `normal_threshold = 0.7`
- **Допуск по позиции**: `position_tolerance = 0.15м` (половина типичной толщины стены)

---

## 3. Четыре направления стен

Здание имеет 4 основных направления стен (работаем с normal.x и normal.y):

### 3.1. Стены с нормалью +X
- **Направление нормали**: `(+1, 0)` - используем только (nx, ny)
- **Критерий**: `normal.x > 0.7`
- **Группировка**: по близкому `Y` (допуск ±0.15м)
- **Вдоль стены**: X меняется, Y постоянен

### 3.2. Стены с нормалью -X
- **Направление нормали**: `(-1, 0)` - используем только (nx, ny)
- **Критерий**: `normal.x < -0.7`
- **Группировка**: по близкому `Y` (допуск ±0.15м)
- **Вдоль стены**: X меняется, Y постоянен

### 3.3. Стены с нормалью +Y
- **Направление нормали**: `(0, +1)` - используем только (nx, ny)
- **Критерий**: `normal.y > 0.7`
- **Группировка**: по близкому `X` (допуск ±0.15м)
- **Вдоль стены**: Y меняется, X постоянен

### 3.4. Стены с нормалью -Y
- **Направление нормали**: `(0, -1)` - используем только (nx, ny)
- **Критерий**: `normal.y < -0.7`
- **Группировка**: по близкому `X` (допуск ±0.15м)
- **Вдоль стены**: Y меняется, X постоянен

---

## 4. Алгоритм группировки граней

### 4.1. Входные данные
- Меш после Voxel Remesh (voxel_size = 0.02м)
- Все грани объекта `Complete_Building_Outline_Remesh_Fine`

### 4.2. Шаги алгоритма

```python
ДЛЯ КАЖДОЙ грани в меше:
    1. Получить нормаль грани (nx, ny, nz)
    2. Нормализовать нормаль

    3. Определить доминантную ось (используем nx и ny, ИГНОРИРУЕМ nz):
       ЕСЛИ |nx| > 0.7:
           dominant_axis = 'X'
           sign = +1 ЕСЛИ nx > 0 ИНАЧЕ -1
       ИНАЧЕ ЕСЛИ |ny| > 0.7:
           dominant_axis = 'Y'
           sign = +1 ЕСЛИ ny > 0 ИНАЧЕ -1
       ИНАЧЕ:
           ПРОПУСТИТЬ грань (нет доминантной нормали по X или Y)

    4. Вычислить центр грани: (cx, cy, cz)

    5. Определить позицию стены:
       ЕСЛИ dominant_axis == 'X':
           position = cy  # группируем по Y
       ИНАЧЕ:  # dominant_axis == 'Y'
           position = cx  # группируем по X

    6. Найти существующую группу или создать новую:
       ДЛЯ КАЖДОЙ существующей группы (group_axis, group_sign, group_position):
           ЕСЛИ group_axis == dominant_axis И group_sign == sign:
               ЕСЛИ |position - group_position| < tolerance:
                   ДОБАВИТЬ грань к этой группе
                   ВЫЙТИ

       ЕСЛИ группа не найдена:
           СОЗДАТЬ новую группу (dominant_axis, sign, position)
           ДОБАВИТЬ грань к новой группе

7. Присвоить номер каждой группе (номер стены)
8. Записать номер стены в BMesh integer layer "wall_number"
```

### 4.3. Структура данных групп

```python
wall_groups = {
    (axis, sign, position): [face1, face2, ...],
    # Примеры:
    ('X', +1, 3.00): [face10, face11, face12, ...],  # Стена смотрит в +X, на линии Y=3.00
    ('X', -1, 3.00): [face20, face21, ...],          # Стена смотрит в -X, на линии Y=3.00
    ('Y', +1, 5.50): [face30, face31, ...],          # Стена смотрит в +Y, на линии X=5.50
    ('Y', -1, 5.50): [face40, face41, ...],          # Стена смотрит в -Y, на линии X=5.50
}
```

---

## 5. Выходные данные

### 5.1. BMesh integer layer "wall_number"
Каждая грань получает целочисленный тег с номером стены (0, 1, 2, ...).
Грани без доминантной нормали получают `-1`.

### 5.2. Словарь wall_info

```python
wall_info = {
    wall_number: {
        'direction': (nx, ny),      # Направление нормали (в плане XY)
        'position': float,          # Позиция стены (X или Y)
        'axis': 'X' или 'Y',        # Доминантная ось
        'face_count': int,          # Количество граней
        'center': (cx, cy, cz),     # Центр стены (средняя позиция всех граней)
        'sign': '+' или '-'         # Знак направления
    }
}
```

### 5.3. JSON файл wall_numbers_debug.json

Содержит `wall_info` в JSON формате для отладки и анализа.

### 5.4. Визуальные метки

Для каждой стены создается красный 3D текстовый объект с номером стены, размещенный в центре стены.

---

## 6. Применение материалов

### 6.1. Логика определения внешней/��нутренней стороны

Для каждой грани:

1. Получить номер стены из integer layer "wall_number"
2. Получить направление нормали стены из `wall_info`
3. Вычислить 2D нормаль грани (проекция на плоскость XY, игнорируя Z)
4. Вычислить dot product между нормалью грани и нормалью стены:

```python
wall_normal_2d = (wall_direction[0], wall_direction[1], 0.0)
face_normal_2d = (face.normal.x, face.normal.y, 0.0)

dot = face_normal_2d · wall_normal_2d
```

5. Применить материал:
   - **ЕСЛИ dot > 0**: External материал (кирпич) - нормаль грани совпадает с нормалью стены
   - **ИНАЧЕ**: Internal материал (белый) - нормаль грани противоположна

### 6.2. Материалы

- **External (кирпич)**: `ProceduralBrickMaterial` - коричнево-красный цвет (0.6, 0.3, 0.1)
- **Internal (белый)**: `WhiteInteriorMaterial` - белый цвет (1.0, 1.0, 1.0)
- **Метки**: `RedLabelMaterial` - красный цвет (1.0, 0.0, 0.0), размер 0.5м

---

## 7. Примеры

### Пример 1: Прямоугольное здание

```
План сверху (вид с высоты, ось Z направлена на нас):

    Y↑
     |
  10 +------------------------+
     |        Стена 0         |
     |      normal (0,+1)     |
     |                        |
  S  |                        |  S
  т  |                        |  т
  е  |                        |  е
  н  |                        |  н
  а  |                        |  а
     |                        |
  3  |                        |  1
     |                        |
  (  |                        |  (
  -  |                        |  +
  1  |                        |  1
  ,  |                        |  ,
  0  |       Стена 2          |  0
  )  |     normal (0,-1)      |  )
     |                        |
   0 +------------------------+---→ X
     0                       20

Ожидаемый результат:
- Стена 0: ось Y+, позиция Y=10, нормаль (0, +1), граней ~100
- Стена 1: ось X+, позиция X=20, нормаль (+1, 0), граней ~100
- Стена 2: ось Y-, позиция Y=0,  нормаль (0, -1), граней ~100
- Стена 3: ось X-, позиция X=0,  нормаль (-1, 0), граней ~100

ВСЕГО: 4 стены
```

### Пример 2: Г-образное здание

```
    Y↑
     |
  15 +-------+
     |   1   |
     | Y+    |
  10 |       +--------+
     |                |
   5 | 0              | 2
     | X-    3   X+   |
     |      Y-        |
   0 +----------------+---→ X
     0      5        15

Ожидаемый результат: 6-8 стен (в зависимости от внутренних углов)
```

---

## 8. Известные проблемы текущей реализации

### Проблема 1: Множественные группы для одной стены

**Симптом**: Вместо ожидаемых 6 стен получается 147 групп.

**Причина**: Алгоритм кластеризации использует фиксированную позицию первой грани группы.

**Пример проблемного сценария**:

```
Грани одной физической стены (Y=3.00±0.15м, нормаль +X):
Формат координат: (X, Y, Z) - где Z игнорируется

Грань #123: center=(4.89, 3.00, -5.64) → создает группу (X, +1, 3.00)
Грань #124: center=(5.05, 3.14, -5.64) → |3.14-3.00|=0.14 < 0.15 ✅ добавлена в группу
Грань #125: center=(5.21, 3.16, -5.64) → |3.16-3.00|=0.16 > 0.15 ❌ НОВАЯ группа!
Грань #126: center=(5.37, 3.18, -5.64) → |3.18-3.00|=0.18 > 0.15 ❌ НОВАЯ группа!
...

Результат: 20+ групп вместо 1 стены
```

**Детали**:
- Voxel remesh с размером 0.02м создает грани с шагом ~0.02м по позиции
- При обработке граней в произвольном порядке образуется "цепочка" разрозненных групп
- Грани с позициями 3.00, 3.14, 3.16, 3.18, ... должны быть в ОДНОЙ группе
- Но каждая сравнивается только с position=3.00 (первая грань), а не с соседними

### Проблема 2: Порядок обработки граней

BMesh не гарантирует порядок обработки граней, что может привести к разным результатам при разных запусках.

---

## 9. Планируемые улучшения

### Улучшение 1: Округление до сетки
Округлять `position` до сетки с шагом 0.3м вместо использования точного значения.

### Улучшение 2: Постобработка - объединение групп
После первичной группировки объединить соседние группы с:
- Одинаковым `(axis, sign)`
- Перекрывающимися или близкими диапазонами позиций

### Улучшение 3: Увеличение допуска
Увеличить `position_tolerance` с 0.15м до 0.3м для учета voxel размера 0.02м.

---

## 10. Ссылки на код

- **Основная функция**: `identify_and_number_walls_from_mesh()` - строки 57-220 в [merge_with_remesh_fine.py](merge_with_remesh_fine.py:57-220)
- **Применение материалов**: `apply_materials_by_wall_numbers()` - строки 475-574 в [merge_with_remesh_fine.py](merge_with_remesh_fine.py:475-574)
- **Визуализация**: `create_wall_number_labels()` - строки 420-473 в [merge_with_remesh_fine.py](merge_with_remesh_fine.py:420-473)
- **Вызов в main()**: строки 844-894 в [merge_with_remesh_fine.py](merge_with_remesh_fine.py:844-894)

---

## История изменений

- **2025-10-27**: Создан документ, описана текущая логика определения стен
- **2025-10-27**: Задокументированы известные проблемы с кластеризацией
